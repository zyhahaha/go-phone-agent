name: Go 自动打包并发布 Release

# 触发条件：仅当推送 v* 格式 Tag 时触发（例如 v1.0.0、v1.1.0-beta）
on:
  push:
    tags:
      - 'v*'

# 新增：明确授予 Release 操作权限
permissions:
  contents: write # 允许读写仓库内容（含 Tag、Release）
  pull-requests: read # 仅读取 PR 信息（可选，按需）

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 步骤 1：拉取仓库完整代码
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 步骤 2：配置 Go 1.21 环境（与你的原配置一致）
      - name: Set up Go 1.21
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      # 步骤 3：下载并整理项目依赖
      - name: Download and tidy dependencies
        run: |
          go mod tidy
          go mod download

      # 步骤 4：多平台编译（完全对应你的 PowerShell 命令，保留所有优化）
      - name: Multi-platform build (windows/linux)
        run: |
          # 创建 bin 目录存放所有产物，避免散落
          mkdir -p bin
          # Windows amd64
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o bin/phone-agent-windows-amd64.exe cmd/main.go
          # Windows 386
          CGO_ENABLED=0 GOOS=windows GOARCH=386 go build -ldflags="-s -w" -o bin/phone-agent-windows-386.exe cmd/main.go
          # Linux amd64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/phone-agent-linux-amd64 cmd/main.go
          # Linux 386
          CGO_ENABLED=0 GOOS=linux GOARCH=386 go build -ldflags="-s -w" -o bin/phone-agent-linux-386 cmd/main.go
          # Linux arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o bin/phone-agent-linux-arm64 cmd/main.go
          # Linux arm
          CGO_ENABLED=0 GOOS=linux GOARCH=arm go build -ldflags="-s -w" -o bin/phone-agent-linux-arm cmd/main.go
          # macOS amd64 (Intel 芯片)
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o bin/phone-agent-macos-amd64 cmd/main.go
          # macOS arm64 (Apple Silicon 芯片，如 M1/M2/M3 系列)
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o bin/phone-agent-macos-arm64 cmd/main.go
          # Termux
          # go build -ldflags="-s -w" -o phone-agent-termux cmd/main.go

      # 步骤 5：自动创建 Release 并上传所有产物（无需手动操作）
      - name: Auto upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: bin/*
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
